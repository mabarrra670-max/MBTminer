<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTminer - Cloud Mining TON Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .nav-active { color: #38bdf8 !important; border-top: 2px solid #38bdf8; background: linear-gradient(to bottom, rgba(56,189,248,0.1), transparent); }
        .hidden { display: none; }
        .mining-glow { box-shadow: 0 0 30px rgba(56, 189, 248, 0.15); }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.95); } }
        .mining-anim { animation: pulse-soft 3s infinite; }
    </style>
</head>
<body class="pb-28">

    <header class="p-5 flex justify-between items-center border-b border-slate-800 bg-slate-950/80 sticky top-0 z-50 glass">
        <div>
            <h1 class="text-2xl font-black text-sky-400 leading-none">MBT<span class="text-white">MINER</span></h1>
            <p id="user-name" class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em] mt-1">Authenticating...</p>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-slate-500 font-bold uppercase">Mining Pool</p>
            <div class="flex items-center gap-2 justify-end">
                <span id="balance" class="text-xl font-mono font-bold text-green-400">0.000000</span>
                <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" class="w-4 h-4">
            </div>
        </div>
    </header>

    <main class="p-4 space-y-6">
        
        <section id="dashboard" class="content-section animate-fade-in">
            <div class="glass p-8 rounded-[2rem] text-center space-y-5 mining-glow border border-sky-500/20">
                <div class="w-32 h-32 rounded-full border-[6px] border-sky-500/10 flex items-center justify-center mx-auto relative">
                    <i class="fas fa-microchip text-5xl text-sky-400 mining-anim"></i>
                    <div class="absolute inset-0 rounded-full border-t-4 border-sky-500 animate-spin" style="animation-duration: 4s;"></div>
                </div>
                <div>
                    <p class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-1">Live Hashrate</p>
                    <p id="current-speed" class="text-2xl font-black font-mono text-white">0.00001 <span class="text-sky-500 text-sm">TON/MIN</span></p>
                </div>
                <button onclick="claimMining()" class="w-full bg-sky-600 hover:bg-sky-500 py-4 rounded-2xl font-black text-sm shadow-xl shadow-sky-900/40 transition-all active:scale-95 uppercase">
                    Claim ke Profil (Min 0.1)
                </button>
            </div>
        </section>

        <section id="shop" class="content-section hidden space-y-4">
            <h2 class="text-xl font-black text-sky-400 px-2 uppercase tracking-tight">Upgrade GPU Rig</h2>
            <div class="grid gap-4">
                <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-sky-500">
                    <div><h3 class="font-bold">Paket Pemula</h3><p class="text-xs text-slate-400">+0.01 TON/Min</p></div>
                    <button onclick="buyPackage(1, 0.01)" class="bg-sky-500 px-5 py-2 rounded-xl text-sm font-black italic">1 TON</button>
                </div>
                <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-blue-500">
                    <div><h3 class="font-bold">Paket Normal</h3><p class="text-xs text-slate-400">+0.1 TON/Min</p></div>
                    <button onclick="buyPackage(5, 0.1)" class="bg-blue-600 px-5 py-2 rounded-xl text-sm font-black italic">5 TON</button>
                </div>
                <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-yellow-500">
                    <div><h3 class="font-bold text-yellow-500">Paket Reguler</h3><p class="text-xs text-slate-400">+0.5 TON/Min</p></div>
                    <button onclick="buyPackage(15, 0.5)" class="bg-yellow-600 px-5 py-2 rounded-xl text-sm font-black italic">15 TON</button>
                </div>
            </div>
        </section>

        <section id="deposit" class="content-section hidden">
            <div class="glass p-6 rounded-[2rem] space-y-6 text-center">
                <div class="space-y-2">
                    <h2 class="text-2xl font-black text-white">Top Up Saldo</h2>
                    <p class="text-xs text-slate-400">Hubungkan wallet untuk mengisi Wallet Internal</p>
                </div>
                <div id="ton-connect-button" class="flex justify-center"></div>
                <div id="deposit-form" class="hidden space-y-4 animate-fade-in">
                    <div class="bg-slate-950 p-4 rounded-2xl border border-slate-800">
                        <p class="text-[10px] text-slate-500 uppercase font-bold mb-2 text-left ml-2">Jumlah TON</p>
                        <input type="number" id="deposit-amount" placeholder="0.00" class="w-full bg-transparent text-center text-2xl font-mono font-bold outline-none text-sky-400">
                    </div>
                    <button onclick="sendTransaction()" class="w-full bg-green-600 py-4 rounded-2xl font-black shadow-lg shadow-green-900/20 active:scale-95 transition-all">KONFIRMASI PEMBAYARAN</button>
                </div>
            </div>
        </section>

        <section id="profile" class="content-section hidden space-y-6">
            <div class="glass p-6 rounded-[2rem] relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-user-shield text-6xl"></i></div>
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-14 h-14 bg-gradient-to-br from-sky-500 to-blue-700 rounded-2xl flex items-center justify-center text-xl shadow-lg shadow-sky-900/40"><i class="fas fa-user-astronaut"></i></div>
                    <div>
                        <h2 id="prof-name" class="font-black text-lg">User Account</h2>
                        <span class="text-[10px] bg-sky-500/20 text-sky-400 px-2 py-0.5 rounded-full font-bold uppercase">Verified Miner</span>
                    </div>
                </div>
                <div class="bg-slate-950/50 p-5 rounded-2xl border border-slate-800">
                    <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1 text-center">Wallet Internal</p>
                    <p class="text-3xl font-mono font-black text-center text-white"><span id="wallet-balance">0.00</span> <span class="text-sm text-sky-500 italic">TON</span></p>
                </div>
            </div>

            <div class="glass p-6 rounded-[2rem] space-y-4">
                <h3 class="font-black text-red-400 uppercase tracking-tight italic">Withdrawal On-Chain</h3>
                <input type="text" id="wd-address" placeholder="UQ Alamat Wallet TON Anda" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-sm font-mono outline-none focus:border-red-500">
                <input type="number" id="wd-amount" placeholder="Jumlah (Min 10 TON)" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl text-sm font-mono outline-none focus:border-red-500">
                <button onclick="processWithdraw()" class="w-full bg-red-600/20 text-red-500 border border-red-500/50 py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-red-600 hover:text-white transition-all">Tarik Saldo</button>
            </div>

            <div class="space-y-3">
                <h3 class="text-[10px] font-black text-slate-500 uppercase px-4 tracking-widest italic">Recent Activity</h3>
                <div id="history-list" class="space-y-2 px-1">
                    </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full glass border-t border-slate-800 flex justify-around p-4 z-50">
        <button onclick="showSection('dashboard')" class="flex flex-col items-center gap-1 nav-active text-slate-500 transition-all">
            <i class="fas fa-bolt"></i><span class="text-[9px] font-bold uppercase">Mining</span>
        </button>
        <button onclick="showSection('shop')" class="flex flex-col items-center gap-1 text-slate-500 transition-all">
            <i class="fas fa-microchip"></i><span class="text-[9px] font-bold uppercase">Rigs</span>
        </button>
        <button onclick="showSection('deposit')" class="flex flex-col items-center gap-1 text-slate-500 transition-all">
            <i class="fas fa-wallet"></i><span class="text-[9px] font-bold uppercase">Topup</span>
        </button>
        <button onclick="showSection('profile')" class="flex flex-col items-center gap-1 text-slate-500 transition-all">
            <i class="fas fa-user-circle"></i><span class="text-[9px] font-bold uppercase">Profil</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyDy6UoeVfwYzdeSpGP_Qr0SVjBMlaDnlWo",
            authDomain: "gamerlovers-d5fc4.firebaseapp.com",
            projectId: "gamerlovers-d5fc4",
            storageBucket: "gamerlovers-d5fc4.firebasestorage.app",
            messagingSenderId: "1029910100614",
            appId: "1:1029910100614:web:177a0b390268d845b72f07"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const userId = tg.initDataUnsafe?.user?.id?.toString() || "dev_user";
        let balance = 0; // Mining Dashboard
        let wallet = 0;  // Internal Wallet
        let speed = 0.00001;

        async function init() {
            const userRef = doc(db, "users", userId);
            const snap = await getDoc(userRef);
            if (snap.exists()) {
                const d = snap.data();
                balance = d.balance || 0;
                wallet = d.wallet || 0;
                speed = d.speed || 0.00001;
                renderHistory(d.history || []);
            } else {
                await setDoc(userRef, { balance: 0, wallet: 0, speed: 0.00001, history: [] });
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance').innerText = balance.toFixed(6);
            document.getElementById('wallet-balance').innerText = wallet.toFixed(4);
            document.getElementById('current-speed').innerText = `${speed} TON/MIN`;
            document.getElementById('user-name').innerText = tg.initDataUnsafe?.user?.first_name || "GUEST ACCOUNT";
            document.getElementById('prof-name').innerText = tg.initDataUnsafe?.user?.first_name || "GUEST";
        }

        // Engine Mining (Refresh UI & Auto Save)
        setInterval(async () => {
            balance += (speed / 60);
            document.getElementById('balance').innerText = balance.toFixed(6);
            if (Math.floor(Date.now()/1000) % 15 === 0) {
                await updateDoc(doc(db, "users", userId), { balance: balance });
            }
        }, 1000);

        // Fitur Claim: Mining -> Wallet Internal
        window.claimMining = async () => {
            if (balance < 0.1) {
                alert("Minimal Claim 0.1 TON!"); return;
            }
            tg.HapticFeedback.impactOccurred('medium');
            const claimAmt = balance;
            wallet += claimAmt; balance = 0;
            const ref = doc(db, "users", userId);
            await updateDoc(ref, { 
                balance: 0, wallet: wallet,
                history: arrayUnion({ type: 'Claim Mining', amount: claimAmt.toFixed(4), date: new Date().toLocaleString() })
            });
            alert("Claim Berhasil!"); location.reload();
        };

        // Fitur Shop
        window.buyPackage = async (price, addedSpeed) => {
            if (wallet >= price) {
                tg.HapticFeedback.impactOccurred('heavy');
                wallet -= price; speed += addedSpeed;
                await updateDoc(doc(db, "users", userId), { 
                    wallet: wallet, speed: speed,
                    history: arrayUnion({ type: 'Buy Package', amount: `-${price}`, date: new Date().toLocaleString() })
                });
                alert("GPU Rig Berhasil Di-Upgrade!"); location.reload();
            } else { alert("Saldo Wallet Internal tidak cukup!"); }
        };

        // Fitur Withdraw On-Chain
        window.processWithdraw = async () => {
            const addr = document.getElementById('wd-address').value;
            const amt = parseFloat(document.getElementById('wd-amount').value);
            if(!addr || isNaN(amt) || amt < 10) { alert("Min 10 TON & Alamat Valid!"); return; }
            if(wallet < amt) { alert("Saldo Wallet Internal tidak cukup!"); return; }
            
            tg.HapticFeedback.notificationOccurred('success');
            wallet -= amt;
            await updateDoc(doc(db, "users", userId), { 
                wallet: wallet,
                history: arrayUnion({ type: 'Withdraw (Pending)', amount: `-${amt}`, date: new Date().toLocaleString(), addr: addr })
            });
            alert("Permintaan WD terkirim! Admin akan memproses pengiriman TON ke wallet Anda.");
            location.reload();
        };

        // TonConnect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://raw.githubusercontent.com/ton-connect/demo-dapp-with-react/master/public/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        window.sendTransaction = async () => {
            const amount = document.getElementById('deposit-amount').value;
            if(!amount || amount <= 0) return;
            try {
                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{ address: "UQC8yBpZY5KwBftoV5SaXc43HSgyXki85iF9qNzNgF6uVNpd", amount: (amount * 1000000000).toString() }]
                };
                await tonConnectUI.sendTransaction(tx);
                alert("Deposit sukses! Saldo akan diverifikasi Admin.");
            } catch (e) { console.error(e); }
        };

        tonConnectUI.onStatusChange(w => {
            document.getElementById('deposit-form').style.display = w ? 'block' : 'none';
        });

        function renderHistory(h) {
            const list = document.getElementById('history-list');
            list.innerHTML = h.reverse().slice(0, 10).map(i => `
                <div class="glass p-3 rounded-xl flex justify-between items-center text-[10px] border border-white/5">
                    <div><p class="font-bold text-white">${i.type}</p><p class="text-slate-500">${i.date}</p></div>
                    <p class="font-mono font-bold ${i.amount.includes('-') ? 'text-red-400' : 'text-green-400'}">${i.amount} TON</p>
                </div>
            `).join('');
        }

        init();
    </script>

    <script>
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
            event.currentTarget.classList.add('nav-active');
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    </script>
</body>
    </html>
